# 后端服务模块详解

> 本文档详细介绍社交媒体平台的11个后端微服务模块

---

## 📦 服务架构总览

```
Spring Cloud Gateway (网关)
    ↓
┌────────────────────────────────────────────────┐
│  11个微服务模块                                  │
│  - 用户服务                                      │
│  - 动态服务                                      │
│  - Feed流服务 ⭐核心                             │
│  - 互动服务                                      │
│  - 评论服务                                      │
│  - 消息服务                                      │
│  - 热搜服务                                      │
│  - 搜索服务                                      │
│  - 网关服务                                      │
│  - 任务调度服务 ⭐新增                           │
│  - 订单服务 ⭐新增                               │
└────────────────────────────────────────────────┘
    ↓
Nacos + MySQL + Redis + Kafka + ES + MongoDB
```

---

## 1️⃣ 用户服务（user-service）

### 业务场景
用户注册、登录、个人信息管理、关注关系管理

### 功能列表
- ✅ 用户注册（手机号/邮箱）
- ✅ 用户登录/登出
- ✅ JWT Token认证
- ✅ 个人资料管理（头像、昵称、简介、生日）
- ✅ 关注/取消关注用户
- ✅ 查询关注列表、粉丝列表
- ✅ 查询共同关注（Redis Set交集）
- ✅ 用户推荐（基于共同关注）
- ✅ 黑名单功能

### 技术要点
- **JWT Token生成与验证**：Token过期时间、刷新机制
- **BCrypt密码加密**：密码安全存储
- **Redis缓存用户信息**：减少数据库查询
- **Redis Set存储关注关系**：快速判断关注状态、计算共同关注
- **关注数、粉丝数实时统计**：Redis计数器

### 数据库设计
- **用户表（user）**：存储用户基本信息、关注数、粉丝数
- **关注关系表（user_follow）**：存储用户关注关系，建立唯一索引防止重复关注

### Redis数据结构
```
# 用户信息缓存
user:info:{userId} -> Hash

# 关注关系
user:follow:{userId} -> Set (存储关注的用户ID)
user:fans:{userId} -> Set (存储粉丝的用户ID)

# 关注数/粉丝数
user:follow:count:{userId} -> String
user:fans:count:{userId} -> String
```

### 核心接口
- `POST /api/user/register` - 用户注册
- `POST /api/user/login` - 用户登录
- `GET /api/user/{id}` - 获取用户信息
- `PUT /api/user/profile` - 更新个人资料
- `POST /api/user/follow/{userId}` - 关注用户
- `DELETE /api/user/follow/{userId}` - 取关用户
- `GET /api/user/follow/list` - 关注列表
- `GET /api/user/fans/list` - 粉丝列表

---

## 2️⃣ 动态服务（post-service）

### 业务场景
用户发布、查看、删除动态，支持多图、视频、话题

### 功能列表
- ✅ 发布动态（纯文字、图片、视频）
- ✅ 多图上传（最多9张）
- ✅ 动态删除（仅自己）
- ✅ 动态详情查询
- ✅ 个人主页动态列表
- ✅ 话题功能（#话题名#）
- ✅ 转发动态（原样转发、评论转发）
- ✅ 收藏动态

### 技术要点
- **图片上传到OSS**：阿里云OSS/本地存储
- **雪花算法生成分布式ID**：保证ID全局唯一且有序
- **MyBatis-Plus分页查询**：动态列表分页
- **话题提取**：正则表达式提取 #话题名#
- **敏感词过滤**：DFA算法/AC自动机

### 数据库设计
- **动态表（post_0 ~ post_7）**：按user_id分表存储，包含动态内容、图片、视频、话题、互动统计等字段
- **动态收藏表（post_favorite）**：存储用户收藏的动态，建立唯一索引防止重复收藏

### 分库分表策略
- **分表规则**：按 `user_id % 8` 路由到 post_0 ~ post_7
- **优势**：单用户查询直接路由到对应分片，性能高
- **全局查询**：通过Elasticsearch实现

### 核心接口
- `POST /api/post` - 发布动态
- `GET /api/post/{id}` - 动态详情
- `DELETE /api/post/{id}` - 删除动态
- `GET /api/post/user/{userId}` - 用户动态列表
- `POST /api/post/forward/{postId}` - 转发动态
- `POST /api/post/favorite/{postId}` - 收藏动态

---

## 3️⃣ Feed流服务（feed-service）⭐核心模块

### 业务场景
用户首页Feed流展示，关注人动态推送

### 功能列表
- ✅ 关注人动态推送（推拉结合模式）
- ✅ 个人主页时间线
- ✅ 热门推荐（根据热度排序）
- ✅ 下拉刷新
- ✅ 上拉加载更多

### 推拉结合模式设计

```
发布动态
    │
    ├─ 粉丝数 < 1000（推模式）
    │   └─ 异步推送到所有活跃粉丝的Feed流
    │      └─ Redis List存储（最多保留1000条）
    │
    └─ 粉丝数 >= 1000（拉模式）
        └─ 用户访问时实时拉取关注人的动态
           └─ 合并排序返回
```

### 技术要点
- **推模式**：发布动态后，异步推送到粉丝收件箱（Redis List）
- **拉模式**：用户访问时，实时查询关注人的最新动态（MySQL）
- **推拉结合**：根据粉丝数阈值动态选择
- **Kafka异步推送**：高吞吐量场景
- **Redis List存储Feed流**：LPUSH、LRANGE操作
- **XXL-Job定时清理**：每天凌晨清理过期Feed数据
- **热门推荐算法**：热度 = 点赞数×1 + 评论数×2 + 转发数×3

### Redis数据结构
```
# 用户Feed流（推模式）
feed:{userId} -> List [postId1, postId2, ...]

# 活跃用户标识（最近3天登录）
active:user -> Set [userId1, userId2, ...]
```

### 核心接口
- `GET /api/feed` - 获取Feed流（分页）
- `GET /api/feed/hot` - 热门推荐
- `POST /api/feed/refresh` - 刷新Feed流

### 性能优化
- 优化前：300ms
- 优化后：50ms
- 优化幅度：83% ↓

---

## 4️⃣ 互动服务（interaction-service）

### 业务场景
点赞、取消点赞、点赞数统计

### 功能列表
- ✅ 点赞动态/取消点赞
- ✅ 点赞数实时统计
- ✅ 防止重复点赞
- ✅ 批量查询点赞状态
- ✅ 查看某条动态的点赞列表

### 技术要点
- **Redis Set存储点赞关系**：防止重复点赞
- **Redis String存储点赞数**：INCR/DECR原子操作
- **Lua脚本保证原子性**：点赞判断+计数一次完成
- **延迟双删策略**：保证缓存一致性
- **XXL-Job定时同步**：每10秒同步Redis到MySQL
- **Canal监听binlog**：实时同步MySQL到Redis

### Redis数据结构
```
# 点赞关系
post:like:{postId} -> Set [userId1, userId2, ...]

# 点赞数
post:like:count:{postId} -> String

# 用户点赞列表
user:like:post:{userId} -> Set [postId1, postId2, ...]
```

### 缓存一致性保证
- **Lua脚本保证原子性**：点赞判断和计数操作使用Lua脚本一次完成，避免并发问题
- **延迟双删策略**：更新数据库时先删除缓存，更新数据库后再延迟删除缓存
- **XXL-Job定时同步**：每10秒将Redis数据同步到MySQL
- **Canal监听binlog**：实时同步MySQL变更到Redis

### 核心接口
- `POST /api/like/{postId}` - 点赞
- `DELETE /api/like/{postId}` - 取消点赞
- `GET /api/like/status` - 批量查询点赞状态
- `GET /api/like/list/{postId}` - 点赞列表

### 性能优化
- 优化前：QPS 1000
- 优化后：QPS 5000+
- 优化幅度：5倍 ↑

---

## 5️⃣ 评论服务（comment-service）

### 业务场景
动态评论、回复评论

### 功能列表
- ✅ 发表一级评论（对动态评论）
- ✅ 发表二级评论（对评论回复）
- ✅ 删除评论（仅自己）
- ✅ 评论列表（分页）
- ✅ 评论排序（时间排序、热度排序）
- ✅ 评论点赞

### 技术要点
- **树形结构存储**：parent_id、root_id字段
- **热度排序**：按点赞数排序
- **Redis缓存热门评论**：减少数据库查询
- **评论数实时统计**：Redis计数器
- **敏感词过滤**：评论内容审核

### 数据库设计
- **评论表（comment）**：树形结构存储，包含parent_id（父评论）和root_id（根评论）字段支持二级评论

### 评论树结构
```
一级评论1
├── 二级评论1-1
├── 二级评论1-2
└── 二级评论1-3
一级评论2
└── 二级评论2-1
```

### 核心接口
- `POST /api/comment` - 发表评论
- `GET /api/comment/list/{postId}` - 评论列表
- `DELETE /api/comment/{id}` - 删除评论
- `POST /api/comment/like/{commentId}` - 评论点赞

---

## 6️⃣ 消息服务（message-service）

### 业务场景
私信聊天、系统通知

### 功能列表
- ✅ 私信功能（一对一聊天）
- ✅ 系统通知（关注、点赞、评论、@我的）
- ✅ 未读消息提醒
- ✅ 消息已读状态
- ✅ 消息列表

### 技术要点
- **WebSocket实时推送**：系统通知
- **Netty实现私信长连接**：可选，性能对比
- **Kafka异步发送**：通知消息异步处理
- **MongoDB存储聊天记录**：文档型数据库适合聊天场景
- **Redis存储未读消息数**：快速查询
- **Redis Pub/Sub集群广播**：多节点WebSocket消息同步
- **消息分类**：系统通知、私信

### 消息推送架构
```
点赞/评论事件
    ↓
Kafka消息队列
    ↓
消息服务消费
    ↓
├─ 在线用户 → WebSocket实时推送
└─ 离线用户 → 存储到MongoDB（下次登录拉取）
```

### Redis数据结构
```
# 未读消息数
message:unread:{userId}:{type} -> String

# 在线用户WebSocket连接
online:user:{userId} -> String (sessionId)
```

### 核心接口
- `WebSocket /ws/message` - WebSocket连接
- `POST /api/message/send` - 发送私信
- `GET /api/message/list` - 消息列表
- `POST /api/message/read/{messageId}` - 标记已读
- `GET /api/message/unread/count` - 未读消息数

---

## 7️⃣ 热搜服务（trending-service）

### 业务场景
实时热搜榜单、话题热度统计

### 功能列表
- ✅ 实时热搜榜单（Top 50）
- ✅ 话题热度统计
- ✅ 热搜趋势（上升、下降、新增）
- ✅ 话题管理

### 热搜算法
```
热度分数 = 搜索次数 / (当前时间 - 发布时间 + 2)^1.5
```

### 技术要点
- **Redis Sorted Set存储榜单**：ZADD、ZREVRANGE
- **XXL-Job定时统计**：每5分钟更新一次
- **时间衰减算法**：参考HackerNews算法
- **话题热度计算**：动态数 + 互动数
- **布隆过滤器**：过滤刷榜行为

### Redis数据结构
```
# 热搜榜单
trending:hot -> Sorted Set (score: 热度分数, member: 话题名)

# 话题搜索次数
trending:search:count:{topic} -> String

# 话题趋势
trending:trend:{topic} -> Hash {rank: 排名, change: 变化}
```

### 核心接口
- `GET /api/trending/hot` - 热搜榜单
- `POST /api/trending/search/{topic}` - 搜索话题（计数）
- `GET /api/trending/trend/{topic}` - 话题趋势

---

## 8️⃣ 搜索服务（search-service）

### 业务场景
全文搜索、搜索建议

### 功能列表
- ✅ 用户搜索（根据昵称、用户名）
- ✅ 动态搜索（全文检索）
- ✅ 话题搜索
- ✅ 搜索结果高亮
- ✅ 搜索建议（自动补全）
- ✅ 搜索历史记录

### 技术要点
- **Elasticsearch全文搜索**：倒排索引
- **IK分词器**：中文分词
- **高亮显示**：highlight字段
- **搜索结果排序**：相关度、热度、时间
- **搜索建议**：completion suggester
- **Canal实时同步**：MySQL binlog → ES索引

### ES索引设计
- **动态索引**：包含postId、userId、content（使用ik_max_word分词器）、topic、likeCount、createdAt等字段
- **分词器配置**：使用IK分词器的ik_max_word进行索引，ik_smart进行搜索

### 核心接口
- `GET /api/search/post` - 搜索动态
- `GET /api/search/user` - 搜索用户
- `GET /api/search/suggest` - 搜索建议
- `GET /api/search/history` - 搜索历史

### 性能指标
- 亿级数据量下，搜索响应时间 < 100ms

---

## 9️⃣ 网关服务（gateway-service）

### 业务场景
统一入口、路由转发、鉴权限流

### 功能列表
- ✅ 统一入口
- ✅ 路由转发
- ✅ 全局过滤器（日志、鉴权）
- ✅ 限流配置
- ✅ 跨域处理
- ✅ WebSocket代理

### 技术要点
- **Spring Cloud Gateway**：响应式网关
- **全局过滤器**：GlobalFilter接口
- **JWT Token验证**：统一鉴权
- **RequestRateLimiter限流**：Redis + Lua脚本
- **CORS跨域配置**：统一处理跨域

### 路由配置示例
Gateway配置路由规则，包括：
- **路由规则**：根据Path路径匹配到对应的微服务
- **限流配置**：使用RequestRateLimiter进行接口限流，支持按IP、用户ID等维度限流
- **过滤器**：StripPrefix去除路径前缀，全局过滤器进行鉴权和日志记录

### 核心功能
- JWT Token统一验证
- 接口限流（QPS限制）
- 黑名单拦截
- 请求日志记录

---

## 🔟 任务调度服务（job-service）⭐新增模块

### 业务场景
定时任务统一管理

### 功能列表
- ✅ 定时清理过期Feed数据（每天凌晨2点）
- ✅ 热搜榜单计算任务（每5分钟）
- ✅ 点赞数据同步任务（每10秒）
- ✅ 用户活跃度统计（每小时）
- ✅ 数据备份任务（每天）
- ✅ 失效缓存清理（每30分钟）
- ✅ 异常任务监控与告警
- ✅ 任务执行日志记录

### 技术要点
- **XXL-Job分布式任务调度**（主要）
  - 动态管理任务（增删改查）
  - Cron表达式配置
  - 任务分片（大数据量处理）
  - 失败重试与告警
  - 任务执行日志查看
  - 路由策略（轮询、一致性哈希）
- **Spring Task**（轻量级任务）
  - @Scheduled注解实现简单定时任务
- **Quartz**（备选方案演示）
  - 任务持久化到数据库

### 任务列表
| 任务名称 | 执行频率 | 任务分片 | 说明 |
|---------|---------|---------|------|
| clearExpiredFeed | 每天凌晨2点 | 否 | 清理30天前的Feed数据 |
| calculateHotTrending | 每5分钟 | 否 | 计算热搜榜单 |
| syncLikeData | 每10秒 | 是 | 同步点赞数据到MySQL |
| statisticsUserActive | 每小时 | 是 | 统计用户活跃度 |
| backupData | 每天凌晨3点 | 否 | 数据库备份 |
| clearCache | 每30分钟 | 否 | 清理失效缓存 |

---

## 1️⃣1️⃣ 订单服务（order-service）⭐新增模块

### 业务场景
会员充值、广告投放、虚拟礼物购买

### 功能列表
- ✅ 创建订单（会员套餐、广告位）
- ✅ 订单支付（支付宝/微信支付对接）
- ✅ 订单查询（分页、状态筛选）
- ✅ 订单超时取消（30分钟未支付）
- ✅ 订单退款处理
- ✅ 积分商城兑换

### 分布式事务场景（Seata重点）

**场景一：订单创建（AT模式）**
```
用户下单购买会员
    ↓
订单服务：创建订单记录
    ↓
用户服务：扣减账户余额
    ↓
会员服务：开通会员权限
    ↓
积分服务：赠送积分
    ↓
Seata协调四个服务的分布式事务
```

**场景二：转发抽奖（TCC模式）**
```
用户转发动态参与抽奖
    ↓
Try：冻结奖品库存 + 冻结用户抽奖次数
    ↓
Confirm：扣减库存 + 发放奖品
    ↓
Cancel：释放库存 + 退回抽奖次数
```

### 技术要点
- **Seata分布式事务**
  - AT模式（自动补偿）：订单创建 + 库存扣减 + 账户扣款
  - TCC模式（手动补偿）：支付场景
  - SAGA模式：长流程订单处理
  - 全局事务超时控制
  - 分支事务回滚
- **雪花算法生成订单号**：保证全局唯一
- **Kafka延时消息**：订单超时取消
- **支付回调幂等性**：防止重复支付
- **订单状态机设计**：状态流转控制

### 订单状态机
```
待支付 → 已支付 → 已完成
   ↓        ↓
 已取消   退款中 → 已退款
```

### 核心接口
- `POST /api/order/create` - 创建订单
- `POST /api/order/pay` - 订单支付
- `GET /api/order/{orderId}` - 订单详情
- `GET /api/order/list` - 订单列表
- `POST /api/order/cancel/{orderId}` - 取消订单
- `POST /api/order/refund/{orderId}` - 申请退款

---

## 🔗 服务间调用关系

```
用户服务
  ↓ OpenFeign
动态服务 → Feed流服务
  ↓           ↓
互动服务   消息服务
  ↓
评论服务
```

---

## 🛠️ 公共模块（common）

### common-core
- 统一返回结果封装
- 异常处理
- 工具类（日期、字符串、JSON等）
- 常量定义

### common-redis
- Redis工具类封装
- 分布式锁实现
- 缓存工具类

### common-web
- 统一异常处理
- 全局拦截器
- 参数校验

### common-mq
- Kafka生产者/消费者封装
- 消息发送工具类
- 消息监听基类

---